{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<style>
    .dashboard-header {
        background: #f8f9fb;
        border: 1px solid #e6e9ef;
        border-radius: 18px;
        padding: 1.75rem;
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
    }

    .dashboard-card {
        border: 1px solid #e6e9ef;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
        border-radius: 14px;
    }

    .kpi-label {
        font-size: 0.9rem;
        letter-spacing: 0.01em;
    }

    .chart-frame {
        height: 300px;
        max-height: 320px;
    }

    .quick-tile {
        text-decoration: none;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .quick-tile:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 26px rgba(15, 23, 42, 0.12);
    }

    .fade-slide {
        animation: fadeSlide 0.6s ease both;
    }

    @keyframes fadeSlide {
        from {
            opacity: 0;
            transform: translateY(12px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (prefers-reduced-motion: reduce) {
        .fade-slide {
            animation: none;
        }
        .quick-tile {
            transition: none;
        }
    }
</style>

<div class="dashboard-header mb-4 fade-slide">
    <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center gap-3">
        <div class="d-flex align-items-center gap-3 flex-wrap">
            <img src="{% static 'img/cfe_logo.svg' %}" alt="CFE" style="height: 52px;">
            <div>
                <h1 class="h3 fw-semibold mb-1">Gerencia de Abastecimientos</h1>
                <p class="text-muted mb-0">Auxiliaria General</p>
            </div>
        </div>
        <div class="ms-lg-auto text-muted small text-lg-end">
            <div class="fw-semibold text-dark">{{ user.get_username }}</div>
            <div>{{ fecha_actual|date:"d/m/Y H:i" }}</div>
        </div>
    </div>
</div>

<section class="mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <h4 class="mb-0">Resumen ejecutivo</h4>
        <span class="text-muted small">Indicadores clave del inventario</span>
    </div>
    <div class="row g-3">
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card dashboard-card h-100 fade-slide" style="animation-delay: 0.05s;">
                <div class="card-body">
                    <p class="text-muted kpi-label mb-1">Total equipos</p>
                    <h3 class="fw-semibold mb-0">{{ total_equipos }}</h3>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card dashboard-card h-100 fade-slide" style="animation-delay: 0.1s;">
                <div class="card-body">
                    <p class="text-muted kpi-label mb-1">Activos</p>
                    <h3 class="fw-semibold mb-0">{{ total_activos }}</h3>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card dashboard-card h-100 fade-slide" style="animation-delay: 0.15s;">
                <div class="card-body">
                    <p class="text-muted kpi-label mb-1">En baja</p>
                    <h3 class="fw-semibold mb-0">{{ total_bajas }}</h3>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card dashboard-card h-100 fade-slide" style="animation-delay: 0.2s;">
                <div class="card-body">
                    <p class="text-muted kpi-label mb-1">% de bajas</p>
                    <h3 class="fw-semibold mb-0">{{ porcentaje_bajas }}%</h3>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card dashboard-card h-100 fade-slide" style="animation-delay: 0.25s;">
                <div class="card-body">
                    <p class="text-muted kpi-label mb-1">Responsables únicos</p>
                    <h3 class="fw-semibold mb-0">{{ responsables_unicos }}</h3>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card dashboard-card h-100 fade-slide" style="animation-delay: 0.3s;">
                <div class="card-body">
                    <p class="text-muted kpi-label mb-1">Centros de costo únicos</p>
                    <h3 class="fw-semibold mb-0">{{ centros_unicos }}</h3>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card dashboard-card h-100 fade-slide" style="animation-delay: 0.35s;">
                <div class="card-body">
                    <p class="text-muted kpi-label mb-1">Críticos</p>
                    <h3 class="fw-semibold mb-0">{{ total_criticos }}</h3>
                    <span class="badge text-bg-success-subtle text-success border border-success-subtle mt-2">
                        Infraestructura crítica
                    </span>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="mb-5">
    <div class="row g-4">
        <div class="col-12 col-lg-6">
            <div class="card dashboard-card h-100 fade-slide" style="animation-delay: 0.1s;">
                <div class="card-body p-3">
                    <h5 class="card-title">Activos vs Bajas</h5>
                    {% if chart_activos_bajas_total %}
                        <div class="chart-frame">
                            <canvas id="chartActivosBajas"></canvas>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">Sin datos para graficar</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-6">
            <div class="card dashboard-card h-100 fade-slide" style="animation-delay: 0.15s;">
                <div class="card-body p-3">
                    <h5 class="card-title">Top 10 Centros de Costo</h5>
                    {% if centros_has_data %}
                        <div class="chart-frame">
                            <canvas id="chartCentros"></canvas>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">Sin datos para graficar</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-6">
            <div class="card dashboard-card h-100 fade-slide" style="animation-delay: 0.2s;">
                <div class="card-body p-3">
                    <h5 class="card-title">Top 10 Marcas</h5>
                    {% if marcas_has_data %}
                        <div class="chart-frame">
                            <canvas id="chartMarcas"></canvas>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">Sin datos para graficar</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-6">
            <div class="card dashboard-card h-100 fade-slide" style="animation-delay: 0.25s;">
                <div class="card-body p-3">
                    <h5 class="card-title">Top 10 Sistemas Operativos</h5>
                    {% if sistemas_has_data %}
                        <div class="chart-frame">
                            <canvas id="chartSistemas"></canvas>
                        </div>
                    {% else %}
                        <p class="text-muted mb-0">Sin datos para graficar</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<section class="mb-5">
    <h4 class="mb-3">Accesos rápidos</h4>
    <div class="row g-3">
        <div class="col-12 col-sm-6 col-lg-3">
            <a class="card dashboard-card h-100 quick-tile fade-slide" style="animation-delay: 0.05s;" href="{% url 'equipos_list' %}">
                <div class="card-body d-flex align-items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="#0d6efd" viewBox="0 0 16 16">
                        <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4.5h12zM2 3a1 1 0 0 1 1-1h2.5a1 1 0 0 1 .8.4l.9 1.2H13a1 1 0 0 1 1 1v.5H2V3z"/>
                    </svg>
                    <div>
                        <div class="fw-semibold">Equipos</div>
                        <div class="text-muted small">Inventario general</div>
                    </div>
                </div>
            </a>
        </div>
        {% if can_view_report %}
            <div class="col-12 col-sm-6 col-lg-3">
                <a class="card dashboard-card h-100 quick-tile fade-slide" style="animation-delay: 0.1s;" href="{% url 'reportes_home' %}">
                    <div class="card-body d-flex align-items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="#198754" viewBox="0 0 16 16">
                            <path d="M4 13V9h2v4H4zm3 0V6h2v7H7zm3 0V3h2v10h-2z"/>
                            <path d="M2 14h12v1H2z"/>
                        </svg>
                        <div>
                            <div class="fw-semibold">Reportes</div>
                            <div class="text-muted small">Indicadores y exportación</div>
                        </div>
                    </div>
                </a>
            </div>
        {% endif %}
        {% if can_import %}
            <div class="col-12 col-sm-6 col-lg-3">
                <a class="card dashboard-card h-100 quick-tile fade-slide" style="animation-delay: 0.15s;" href="{% url 'importar' %}">
                    <div class="card-body d-flex align-items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="#0d6efd" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5-.4h4v1H1.5a.5.5 0 0 1-.5-.5v-.1z"/>
                            <path d="M7.646 4.646a.5.5 0 0 1 .708 0L11 7.293l-2.646 2.647a.5.5 0 0 1-.708-.708L9.793 7 7.646 4.854a.5.5 0 0 1 0-.708z"/>
                            <path d="M5 1.5A1.5 1.5 0 0 0 3.5 0h-2A1.5 1.5 0 0 0 0 1.5v13A1.5 1.5 0 0 0 1.5 16h2A1.5 1.5 0 0 0 5 14.5v-13z"/>
                        </svg>
                        <div>
                            <div class="fw-semibold">Importar</div>
                            <div class="text-muted small">Carga de CSV</div>
                        </div>
                    </div>
                </a>
            </div>
        {% endif %}
        {% if can_baja %}
            <div class="col-12 col-sm-6 col-lg-3">
                <a class="card dashboard-card h-100 quick-tile fade-slide" style="animation-delay: 0.2s;" href="{% url 'bajas_list' %}">
                    <div class="card-body d-flex align-items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="#dc3545" viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 5h4a.5.5 0 0 1 0 1H6a.5.5 0 0 1-.5-.5z"/>
                            <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1 0-2h3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3a1 1 0 0 1 1 1z"/>
                        </svg>
                        <div>
                            <div class="fw-semibold">Bajas</div>
                            <div class="text-muted small">Gestión de retiros</div>
                        </div>
                    </div>
                </a>
            </div>
        {% endif %}
        {% if can_audit %}
            <div class="col-12 col-sm-6 col-lg-3">
                <a class="card dashboard-card h-100 quick-tile fade-slide" style="animation-delay: 0.25s;" href="{% url 'auditoria_list' %}">
                    <div class="card-body d-flex align-items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="#198754" viewBox="0 0 16 16">
                            <path d="M8 0c-.69 0-1.355.06-2 .176V1.5A.5.5 0 0 0 6.5 2h3a.5.5 0 0 0 .5-.5V.176A8.027 8.027 0 0 0 8 0z"/>
                            <path d="M3 2.5a.5.5 0 0 1 .5-.5H5v.5a1.5 1.5 0 0 0 3 0V2h1v.5a1.5 1.5 0 0 0 3 0V2h1.5a.5.5 0 0 1 .5.5V4H3V2.5z"/>
                            <path d="M3 5h10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5zm5 2a.5.5 0 0 0-.5.5v2.293l-1.146 1.147a.5.5 0 1 0 .708.707l1.292-1.292A.5.5 0 0 0 8.5 10V7.5a.5.5 0 0 0-.5-.5z"/>
                        </svg>
                        <div>
                            <div class="fw-semibold">Auditoría</div>
                            <div class="text-muted small">Registro de acciones</div>
                        </div>
                    </div>
                </a>
            </div>
        {% endif %}
        {% if perms.equipos.add_equipo %}
            <div class="col-12 col-sm-6 col-lg-3">
                <a class="card dashboard-card h-100 quick-tile fade-slide" style="animation-delay: 0.3s;" href="/admin/equipos/equipo/add/">
                    <div class="card-body d-flex align-items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="#0d6efd" viewBox="0 0 16 16">
                            <path d="M8 4a.5.5 0 0 1 .5.5V7h2.5a.5.5 0 0 1 0 1H8.5v2.5a.5.5 0 0 1-1 0V8H5a.5.5 0 0 1 0-1h2.5V4.5A.5.5 0 0 1 8 4z"/>
                            <path d="M4.5 1A1.5 1.5 0 0 0 3 2.5v11A1.5 1.5 0 0 0 4.5 15h7A1.5 1.5 0 0 0 13 13.5v-11A1.5 1.5 0 0 0 11.5 1h-7z"/>
                        </svg>
                        <div>
                            <div class="fw-semibold">Nuevo equipo</div>
                            <div class="text-muted small">Alta inmediata</div>
                        </div>
                    </div>
                </a>
            </div>
        {% endif %}
    </div>
</section>

<section class="mb-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <h4 class="mb-0">Actividad reciente</h4>
        <span class="text-muted small">Movimientos recientes y auditoría</span>
    </div>
    <div class="row g-4">
        {% if mostrar_import_logs %}
            <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-body">
                        <h5 class="card-title">Últimas 5 importaciones</h5>
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Usuario</th>
                                        <th>Resultados</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in import_logs %}
                                        <tr>
                                            <td>{{ log.fecha|date:"d/m/Y H:i" }}</td>
                                            <td>{{ log.usuario.get_username|default:"-" }}</td>
                                            <td class="text-muted">
                                                C: {{ log.creados }} · A: {{ log.actualizados }} · E: {{ log.errores }}
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="3" class="text-muted">Sin registros recientes.</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        {% if mostrar_bajas %}
            <div class="col-12 col-lg-6">
                <div class="card dashboard-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Últimas 10 bajas</h5>
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Equipo</th>
                                        <th>Tipo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for baja in bajas_recientes %}
                                        <tr>
                                            <td>{{ baja.fecha_baja|date:"d/m/Y H:i" }}</td>
                                            <td>
                                                {{ baja.equipo.identificador }}
                                                {% if baja.equipo.infraestructura_critica %}
                                                    <span class="badge text-bg-success-subtle text-success border border-success-subtle ms-2">
                                                        Crítico
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>{{ baja.get_tipo_baja_display }}</td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="3" class="text-muted">Sin registros recientes.</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        {% if mostrar_audit_logs %}
            <div class="col-12 col-lg-6">
                <div class="card dashboard-card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Últimas 10 auditorías</h5>
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Acción</th>
                                        <th>Usuario</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for audit in audit_logs %}
                                        <tr>
                                            <td>{{ audit.fecha|date:"d/m/Y H:i" }}</td>
                                            <td>
                                                {{ audit.accion }}
                                                {% if audit.equipo and audit.equipo.infraestructura_critica %}
                                                    <span class="badge text-bg-success-subtle text-success border border-success-subtle ms-2">
                                                        Crítico
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>{{ audit.usuario.get_username|default:"-" }}</td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="3" class="text-muted">Sin registros recientes.</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    const chartActivosBajasEl = document.getElementById("chartActivosBajas");
    if (chartActivosBajasEl) {
        new Chart(chartActivosBajasEl, {
            type: "doughnut",
            data: {
                labels: {{ chart_activos_bajas_labels|safe }},
                datasets: [{
                    data: {{ chart_activos_bajas|safe }},
                    backgroundColor: ["#198754", "#adb5bd"],
                }],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: "bottom",
                    },
                },
            },
        });
    }

    const chartCentrosEl = document.getElementById("chartCentros");
    if (chartCentrosEl) {
        new Chart(chartCentrosEl, {
            type: "bar",
            data: {
                labels: {{ chart_centros_labels|safe }},
                datasets: [{
                    label: "Equipos",
                    data: {{ chart_centros_data|safe }},
                    backgroundColor: "#0d6efd",
                }],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: "bottom" },
                },
                scales: {
                    x: { ticks: { autoSkip: false } },
                },
            },
        });
    }

    const chartMarcasEl = document.getElementById("chartMarcas");
    if (chartMarcasEl) {
        new Chart(chartMarcasEl, {
            type: "bar",
            data: {
                labels: {{ chart_marcas_labels|safe }},
                datasets: [{
                    label: "Equipos",
                    data: {{ chart_marcas_data|safe }},
                    backgroundColor: "#198754",
                }],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: "bottom" },
                },
            },
        });
    }

    const chartSistemasEl = document.getElementById("chartSistemas");
    if (chartSistemasEl) {
        new Chart(chartSistemasEl, {
            type: "bar",
            data: {
                labels: {{ chart_sistemas_labels|safe }},
                datasets: [{
                    label: "Equipos",
                    data: {{ chart_sistemas_data|safe }},
                    backgroundColor: "#6c757d",
                }],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: "bottom" },
                },
            },
        });
    }
</script>
{% endblock %}
